{% comment %}
  Main Search Section - Elle Theme
  Search results with filtering and predictive search (REQUIRED FOR THEME STORE)
{% endcomment %}

{%- liquid
  assign products_per_page = section.settings.products_per_page
  assign columns_desktop = section.settings.columns_desktop
  assign columns_mobile = section.settings.columns_mobile
  assign show_filters = section.settings.show_filters
  assign show_sorting = section.settings.show_sorting
-%}

<section
  class="main-search section {% render 'color-scheme', scheme: section.settings.color_scheme %} section-padding--top-{{ section.settings.padding_top }} section-padding--bottom-{{ section.settings.padding_bottom }}"
>
  {% render 'page-header', title: 'search.title' | t %}

  <div class="container">
    {%- comment -%} Search Form {%- endcomment -%}
    <div class="search-form-wrapper" data-animate="fade-up">
      <div class="search-form-container">
        <form action="{{ routes.search_url }}" method="get" role="search" class="search-form search-form--large">
          <label for="Search-{{ section.id }}" class="visually-hidden">{{ 'search.placeholder' | t }}</label>
          <input
            type="search"
            id="Search-{{ section.id }}"
            name="q"
            value="{{ search.terms | escape }}"
            class="search-form__input form-input"
            placeholder="{{ 'search.placeholder' | t }}"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
          >
          <input type="hidden" name="type" value="product,article,page,collection">
          <button type="submit" class="search-form__submit btn btn--filled">
            {% render 'icon', icon: 'search' %}
            <span class="visually-hidden">{{ 'search.search' | t }}</span>
          </button>
        </form>
      </div>

      {%- if search.performed -%}
        <p class="search-results-count">
          {%- if search.results_count == 0 -%}
            {{ 'search.no_results' | t: terms: search.terms }}
          {%- else -%}
            {{ 'search.results_count' | t: count: search.results_count, terms: search.terms }}
          {%- endif -%}
        </p>
      {%- endif -%}
    </div>

    {%- if search.performed -%}
      {%- if search.results_count > 0 -%}
        {%- comment -%} Search Toolbar {%- endcomment -%}
        <div class="search-toolbar">
          {%- comment -%} Type Filter Tabs {%- endcomment -%}
          <div class="search-toolbar__tabs">
            <a
              href="{{ routes.search_url }}?q={{ search.terms | url_encode }}&type=product,article,page"
              class="search-toolbar__tab{% unless search.types %} is-active{% endunless %}"
            >
              {{ 'search.all' | t }}
            </a>
            <a
              href="{{ routes.search_url }}?q={{ search.terms | url_encode }}&type=product"
              class="search-toolbar__tab{% if search.types contains 'product' and search.types.size == 1 %} is-active{% endif %}"
            >
              {{ 'search.products' | t }}
            </a>
            <a
              href="{{ routes.search_url }}?q={{ search.terms | url_encode }}&type=article"
              class="search-toolbar__tab{% if search.types contains 'article' and search.types.size == 1 %} is-active{% endif %}"
            >
              {{ 'search.articles' | t }}
            </a>
            <a
              href="{{ routes.search_url }}?q={{ search.terms | url_encode }}&type=page"
              class="search-toolbar__tab{% if search.types contains 'page' and search.types.size == 1 %} is-active{% endif %}"
            >
              {{ 'search.pages' | t }}
            </a>
          </div>

          {%- comment -%} Sort {%- endcomment -%}
          {%- if show_sorting -%}
            <div class="search-toolbar__sort">
              <label for="SearchSortBy" class="visually-hidden">{{ 'collection.sorting.label' | t }}</label>
              <select id="SearchSortBy" class="form-select" data-search-sort>
                <option value="relevance" {% if search.sort_by == 'relevance' %}selected{% endif %}>
                  {{ 'search.sort.relevance' | t }}
                </option>
                <option value="price-ascending" {% if search.sort_by == 'price-ascending' %}selected{% endif %}>
                  {{ 'search.sort.price_asc' | t }}
                </option>
                <option value="price-descending" {% if search.sort_by == 'price-descending' %}selected{% endif %}>
                  {{ 'search.sort.price_desc' | t }}
                </option>
              </select>
            </div>
          {%- endif -%}
        </div>

        {%- comment -%} Faceted Filters (for products) {%- endcomment -%}
        {%- if show_filters and search.filters.size > 0 -%}
          <div class="search-filters-container">
            <aside class="search-filters" data-search-filters>
              <form id="SearchFiltersForm" data-search-filters-form>
                {%- for filter in search.filters -%}
                  <details
                    class="search-filter"
                    {% if filter.active_values.size > 0 or forloop.index <= 3 %}open{% endif %}
                  >
                    <summary class="search-filter__heading">
                      <span>{{ filter.label }}</span>
                      {% render 'icon', icon: 'chevron-down', size: 'sm' %}
                    </summary>

                    <div class="search-filter__content">
                      {%- case filter.type -%}
                        {%- when 'list' -%}
                          <ul class="search-filter__list" role="list">
                            {%- for value in filter.values -%}
                              <li>
                                <label class="search-filter__label">
                                  <input
                                    type="checkbox"
                                    name="{{ value.param_name }}"
                                    value="{{ value.value }}"
                                    {% if value.active %}checked{% endif %}
                                    class="search-filter__checkbox"
                                    data-filter-input
                                  >
                                  <span class="search-filter__checkbox-visual"></span>
                                  <span class="search-filter__text">{{ value.label }}</span>
                                  <span class="search-filter__count">({{ value.count }})</span>
                                </label>
                              </li>
                            {%- endfor -%}
                          </ul>

                        {%- when 'price_range' -%}
                          <div class="search-filter__price-range">
                            <div class="search-filter__price-inputs">
                              <div class="search-filter__price-field">
                                <label for="Filter-{{ filter.param_name }}-GTE">{{ 'collection.filters.from' | t }}</label>
                                <input
                                  type="number"
                                  id="Filter-{{ filter.param_name }}-GTE"
                                  name="{{ filter.min_value.param_name }}"
                                  class="form-input"
                                  min="0"
                                  {% if filter.min_value.value %}value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"{% endif %}
                                  placeholder="0"
                                  data-filter-input
                                >
                              </div>
                              <span>â€”</span>
                              <div class="search-filter__price-field">
                                <label for="Filter-{{ filter.param_name }}-LTE">{{ 'collection.filters.to' | t }}</label>
                                <input
                                  type="number"
                                  id="Filter-{{ filter.param_name }}-LTE"
                                  name="{{ filter.max_value.param_name }}"
                                  class="form-input"
                                  min="0"
                                  {% if filter.max_value.value %}value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"{% endif %}
                                  data-filter-input
                                >
                              </div>
                            </div>
                          </div>
                      {%- endcase -%}
                    </div>
                  </details>
                {%- endfor -%}

                <noscript>
                  <button type="submit" class="btn btn--filled">{{ 'collection.filters.apply' | t }}</button>
                </noscript>
              </form>
            </aside>
          </div>
        {%- endif -%}

        {%- comment -%} Search Results {%- endcomment -%}
        {%- paginate search.results by products_per_page -%}
          <div
            class="search-results__grid grid"
            style="--grid-columns-desktop: {{ columns_desktop }}; --grid-columns-mobile: {{ columns_mobile }};"
          >
            {%- for item in search.results -%}
              {%- assign animation_delay = forloop.index0 | modulo: columns_desktop | times: 100 -%}
              <div class="search-results__item" data-animate="fade-up" data-animate-delay="{{ animation_delay }}">
                {%- case item.object_type -%}
                  {%- when 'product' -%}
                    {% render 'product-card', product: item %}

                  {%- when 'article' -%}
                    {% render 'article-card', article: item %}

                  {%- when 'page' -%}
                    <div class="page-card">
                      <h3 class="page-card__title h4">
                        <a href="{{ item.url }}">{{ item.title }}</a>
                      </h3>
                      {%- if item.content != blank -%}
                        <p class="page-card__excerpt">
                          {{ item.content | strip_html | truncate: 150 }}
                        </p>
                      {%- endif -%}
                    </div>
                {%- endcase -%}
              </div>
            {%- endfor -%}
          </div>

          {%- comment -%} Pagination {%- endcomment -%}
          {%- if paginate.pages > 1 -%}
            <nav class="pagination" aria-label="{{ 'accessibility.pagination' | t }}">
              <ul class="pagination__list">
                {%- if paginate.previous -%}
                  <li class="pagination__item">
                    <a href="{{ paginate.previous.url }}" class="pagination__link pagination__link--prev">
                      {% render 'icon', icon: 'chevron-left', size: 'sm' %}
                      {{ 'pagination.previous' | t }}
                    </a>
                  </li>
                {%- endif -%}

                {%- for part in paginate.parts -%}
                  <li class="pagination__item">
                    {%- if part.is_link -%}
                      <a href="{{ part.url }}" class="pagination__link">{{ part.title }}</a>
                    {%- else -%}
                      {%- if part.title == paginate.current_page -%}
                        <span class="pagination__link pagination__link--current" aria-current="page">{{ part.title }}</span>
                      {%- else -%}
                        <span class="pagination__link pagination__link--ellipsis">{{ part.title }}</span>
                      {%- endif -%}
                    {%- endif -%}
                  </li>
                {%- endfor -%}

                {%- if paginate.next -%}
                  <li class="pagination__item">
                    <a href="{{ paginate.next.url }}" class="pagination__link pagination__link--next">
                      {{ 'pagination.next' | t }}
                      {% render 'icon', icon: 'chevron-right', size: 'sm' %}
                    </a>
                  </li>
                {%- endif -%}
              </ul>
            </nav>
          {%- endif -%}
        {%- endpaginate -%}
      {%- else -%}
        {%- comment -%} No Results {%- endcomment -%}
        <div class="search-empty">
          <p>{{ 'search.no_results_html' | t: terms: search.terms }}</p>
          <h2 class="h4">{{ 'search.suggestions' | t }}</h2>
          <ul>
            <li>{{ 'search.suggestion_1' | t }}</li>
            <li>{{ 'search.suggestion_2' | t }}</li>
            <li>{{ 'search.suggestion_3' | t }}</li>
          </ul>
        </div>
      {%- endif -%}
    {%- endif -%}

    {%- comment -%} Screen Reader Announcements {%- endcomment -%}
    <div class="visually-hidden" aria-live="polite" aria-atomic="true" data-search-announce>
      {%- if search.performed and search.results_count > 0 -%}
        {{ 'search.results_count' | t: count: search.results_count, terms: search.terms }}
      {%- endif -%}
    </div>
  </div>
</section>

<script>
// Sort change handler
document.addEventListener('DOMContentLoaded', () => {
  const sortSelect = document.querySelector('[data-search-sort]');
  if (sortSelect) {
    sortSelect.addEventListener('change', () => {
      const url = new URL(window.location.href);
      url.searchParams.set('sort_by', sortSelect.value);
      window.location.href = url.toString();
    });
  }

  // Filter change handlers
  const filterInputs = document.querySelectorAll('[data-filter-input]');
  filterInputs.forEach(input => {
    input.addEventListener('change', () => {
      document.getElementById('SearchFiltersForm').submit();
    });
  });
});
</script>

{% stylesheet %}
/* Main Search Section */
.main-search {
  padding: var(--section-padding-top) 0 var(--section-padding-bottom);
}

/* Search Header */
.search-header {
  text-align: center;
  margin-bottom: var(--space-8);
}

.search-header__title {
  margin: 0 0 var(--space-4);
}

.search-header__form {
  max-width: 600px;
  margin: 0 auto;
}

.search-header__results-count {
  margin-top: var(--space-4);
  color: var(--color-muted);
}

/* Search Toolbar */
.search-toolbar {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: var(--space-4);
  margin-bottom: var(--space-6);
  padding-bottom: var(--space-4);
  border-bottom: 1px solid var(--color-border);
}

.search-toolbar__tabs {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-1);
}

.search-toolbar__tab {
  padding: var(--space-2) var(--space-4);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
  background: transparent;
  text-decoration: none;
  font-size: var(--font-size-sm);
  transition: all var(--duration-fast);
}

.search-toolbar__tab:hover,
.search-toolbar__tab.is-active {
  background: var(--color-foreground);
  color: var(--color-background);
  border-color: var(--color-foreground);
}

.search-toolbar__sort {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

/* Search Layout with Filters */
.search-filters-container {
  margin-bottom: var(--space-6);
}

@media (min-width: 990px) {
  .search-filters-container {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: var(--space-8);
  }
}

/* Search Filters */
.search-filters {
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.search-filter {
  border-bottom: 1px solid var(--color-border);
}

.search-filter__heading {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-3) 0;
  cursor: pointer;
  font-weight: var(--font-weight-medium);
  list-style: none;
}

.search-filter__heading::-webkit-details-marker {
  display: none;
}

.search-filter__heading svg {
  transition: transform var(--duration-fast);
}

.search-filter[open] .search-filter__heading svg {
  transform: rotate(180deg);
}

.search-filter__content {
  padding: var(--space-2) 0 var(--space-4);
}

.search-filter__list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.search-filter__label {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  cursor: pointer;
  font-size: var(--font-size-sm);
}

.search-filter__checkbox {
  width: 1rem;
  height: 1rem;
  accent-color: var(--color-foreground);
}

.search-filter__checkbox-visual {
  display: inline-block;
  width: 1.25rem;
  height: 1.25rem;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-xs);
  position: relative;
  flex-shrink: 0;
}

.search-filter__checkbox:checked + .search-filter__checkbox-visual {
  background-color: var(--color-foreground);
  border-color: var(--color-foreground);
}

.search-filter__checkbox:checked + .search-filter__checkbox-visual::after {
  content: '';
  position: absolute;
  left: 50%;
  top: 45%;
  width: 0.25rem;
  height: 0.5rem;
  border: solid var(--color-background);
  border-width: 0 2px 2px 0;
  transform: translate(-50%, -50%) rotate(45deg);
}

.search-filter__count {
  color: var(--color-muted);
  font-size: var(--font-size-xs);
  margin-left: auto;
}

.search-filter__price-range {
  display: flex;
  gap: var(--space-2);
  align-items: center;
}

.search-filter__price-inputs {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.search-filter__price-field {
  flex: 1;
}

.search-filter__price-field label {
  display: block;
  font-size: var(--font-size-xs);
  color: var(--color-muted);
  margin-bottom: var(--space-1);
}

.search-filter__price-field .form-input {
  width: 100%;
}

/* Search Results Grid */
.search-results__grid {
  display: grid;
  gap: var(--grid-gap, var(--space-6));
  grid-template-columns: repeat(var(--grid-columns-mobile, 1), 1fr);
}

@media (min-width: 750px) {
  .search-results__grid {
    grid-template-columns: repeat(var(--grid-columns-desktop, 4), 1fr);
  }
}

.search-results__item {
  display: flex;
}

/* Page Card (for page results) */
.page-card {
  display: flex;
  flex-direction: column;
  width: 100%;
  padding: var(--space-6);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  text-decoration: none;
  transition: border-color var(--duration-fast), box-shadow var(--duration-fast);
}

.page-card:hover {
  border-color: var(--color-foreground);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.page-card__title {
  margin: 0 0 var(--space-2);
}

.page-card__title a {
  text-decoration: none;
  color: inherit;
}

.page-card__title a:hover {
  text-decoration: underline;
}

.page-card__excerpt {
  color: var(--color-muted);
  font-size: var(--font-size-sm);
  line-height: 1.6;
  margin: 0;
}

/* Search Empty State */
.search-empty {
  text-align: center;
  padding: var(--space-12) var(--space-4);
}

.search-empty p {
  margin-bottom: var(--space-6);
}

.search-empty h2 {
  margin-bottom: var(--space-4);
}

.search-empty ul {
  list-style: none;
  padding: 0;
  margin: 0;
  color: var(--color-muted);
}

.search-empty li {
  margin-bottom: var(--space-2);
}

/* Pagination */
.main-search .pagination {
  margin-top: var(--space-12);
}
{% endstylesheet %}

{% schema %}
{
  "name": "t:sections.main_search.name",
  "tag": "section",
  "class": "section-main-search",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_filters",
      "label": "t:sections.main_search.settings.show_filters.label",
      "info": "t:sections.main_search.settings.show_filters.info",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_sorting",
      "label": "t:sections.main_search.settings.show_sorting.label",
      "default": true
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "t:sections.main_search.settings.products_per_page.label",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 16
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "t:labels.columns_desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "t:labels.columns_mobile",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ],
      "default": "2"
    },
    {
      "type": "header",
      "content": "t:labels.section"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:labels.color_scheme",
      "default": "scheme_1"
    },
    {
      "type": "select",
      "id": "padding_top",
      "label": "t:labels.padding_top",
      "options": [
        { "value": "none", "label": "t:options.padding.none" },
        { "value": "small", "label": "t:options.padding.small" },
        { "value": "medium", "label": "t:options.padding.medium" },
        { "value": "large", "label": "t:options.padding.large" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "padding_bottom",
      "label": "t:labels.padding_bottom",
      "options": [
        { "value": "none", "label": "t:options.padding.none" },
        { "value": "small", "label": "t:options.padding.small" },
        { "value": "medium", "label": "t:options.padding.medium" },
        { "value": "large", "label": "t:options.padding.large" }
      ],
      "default": "medium"
    }
  ]
}
{% endschema %}
