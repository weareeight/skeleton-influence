{% comment %}
  Main Article Section - Influence Theme
  Displays a single blog article with featured image, content, and comments
  Editorial reading experience with progress bar, read time, and drop caps
{% endcomment %}

{%- comment -%} Load blog styles and scripts {%- endcomment -%}
{{ 'blog.css' | asset_url | stylesheet_tag }}
<script src="{{ 'blog.js' | asset_url }}" defer></script>

{%- comment -%} Calculate estimated read time {%- endcomment -%}
{%- liquid
  assign word_count = article.content | strip_html | split: ' ' | size
  assign read_time = word_count | divided_by: 250
  if read_time < 1
    assign read_time = 1
  endif
-%}

{%- comment -%} Reading Progress Bar {%- endcomment -%}
{%- if section.settings.show_progress_bar -%}
  {% render 'reading-progress' %}
{%- endif -%}

<article
  class="main-article section {% render 'color-scheme', scheme: section.settings.color_scheme %}"
  {% if section.settings.enable_drop_caps %}data-drop-caps{% endif %}
  {% if section.settings.drop_cap_style != 'default' %}data-drop-cap-style="{{ section.settings.drop_cap_style }}"{% endif %}
>
  <div class="container">
    {%- comment -%} Article Header {%- endcomment -%}
    <header class="article-header" data-animate="fade-up">
      {%- if section.settings.show_breadcrumb -%}
        <nav class="article-breadcrumb" aria-label="{{ 'accessibility.breadcrumb' | t }}">
          <a href="{{ routes.root_url }}">{{ 'breadcrumb.home' | t }}</a>
          <span class="article-breadcrumb__separator">/</span>
          <a href="{{ blog.url }}">{{ blog.title }}</a>
          <span class="article-breadcrumb__separator">/</span>
          <span aria-current="page">{{ article.title }}</span>
        </nav>
      {%- endif -%}

      {%- comment -%} Category (first tag) + Read Time {%- endcomment -%}
      <div class="article-header__meta-top">
        {%- if section.settings.show_tags and article.tags.size > 0 -%}
          <a href="{{ blog.url }}/tagged/{{ article.tags.first | handle }}" class="article-header__category">
            {{ article.tags.first }}
          </a>
        {%- endif -%}
        {%- if section.settings.show_tags and article.tags.size > 0 and section.settings.show_read_time -%}
          <span class="article-header__divider"></span>
        {%- endif -%}
        {%- if section.settings.show_read_time -%}
          <span class="article-header__read-time" data-read-time>
            {{ read_time }} {{ 'article.min_read' | t }}
          </span>
        {%- endif -%}
      </div>

      <h1 class="article-header__title article__title">{{ article.title }}</h1>

      {%- if article.excerpt != blank and section.settings.show_excerpt -%}
        <p class="article-header__excerpt article__excerpt">{{ article.excerpt | strip_html }}</p>
      {%- endif -%}

      {%- if section.settings.show_date or section.settings.show_author -%}
        <div class="article-header__meta">
          {%- if section.settings.show_author -%}
            <span class="article-header__author">
              {{ 'blog.by' | t }} {{ article.author }}
            </span>
          {%- endif -%}
          {%- if section.settings.show_author and section.settings.show_date -%}
            <span class="article-header__separator">Â·</span>
          {%- endif -%}
          {%- if section.settings.show_date -%}
            <time class="article-header__date" datetime="{{ article.published_at | date: '%Y-%m-%d' }}">
              {{ article.published_at | date: format: 'date' }}
            </time>
          {%- endif -%}
        </div>
      {%- endif -%}
    </header>

    {%- comment -%} Featured Image {%- endcomment -%}
    {%- if section.settings.show_featured_image and article.image -%}
      <figure class="article-featured-image" data-animate="fade-up" data-animate-delay="100">
        {{
          article.image
          | image_url: width: 1400
          | image_tag:
            loading: 'eager',
            sizes: '(min-width: 1200px) 900px, (min-width: 750px) 80vw, 100vw',
            widths: '375, 750, 1100, 1400',
            class: 'article-featured-image__img',
            alt: article.image.alt | default: article.title
        }}
        {%- if article.image.alt != blank -%}
          <figcaption class="article-featured-image__caption">
            {{ article.image.alt }}
          </figcaption>
        {%- endif -%}
      </figure>
    {%- endif -%}

    {%- comment -%} Article Content {%- endcomment -%}
    <div class="article-content article__content rte" data-article-content data-animate="fade-up" data-animate-delay="200">
      {{ article.content }}
    </div>

    {%- comment -%} Social Share {%- endcomment -%}
    {%- if section.settings.show_share -%}
      <div class="article-share">
        <span class="article-share__label">{{ 'article.share' | t }}</span>
        <div class="article-share__links">
          <a
            href="https://www.facebook.com/sharer/sharer.php?u={{ article.url | prepend: request.origin | url_encode }}"
            target="_blank"
            rel="noopener noreferrer nofollow"
            class="article-share__link"
            aria-label="{{ 'accessibility.share_facebook' | t }}"
          >
            {% render 'icon', icon: 'facebook' %}
          </a>
          <a
            href="https://twitter.com/intent/tweet?url={{ article.url | prepend: request.origin | url_encode }}&text={{ article.title | url_encode }}"
            target="_blank"
            rel="noopener noreferrer nofollow"
            class="article-share__link"
            aria-label="{{ 'accessibility.share_twitter' | t }}"
          >
            {% render 'icon', icon: 'twitter' %}
          </a>
          <a
            href="https://pinterest.com/pin/create/button/?url={{ article.url | prepend: request.origin | url_encode }}&media={{ article.image | image_url: width: 1200 | prepend: 'https:' | url_encode }}&description={{ article.title | url_encode }}"
            target="_blank"
            rel="noopener noreferrer nofollow"
            class="article-share__link"
            aria-label="{{ 'accessibility.share_pinterest' | t }}"
          >
            {% render 'icon', icon: 'pinterest' %}
          </a>
          <a
            href="mailto:?subject={{ article.title | url_encode }}&body={{ article.url | prepend: request.origin | url_encode }}"
            class="article-share__link"
            aria-label="{{ 'accessibility.share_email' | t }}"
          >
            {% render 'icon', icon: 'email' %}
          </a>
        </div>
      </div>
    {%- endif -%}

    {%- comment -%} Author Bio {%- endcomment -%}
    {%- if section.settings.show_author_bio -%}
      {% render 'author-bio', article: article %}
    {%- endif -%}

    {%- comment -%} Article Navigation - Enhanced with Thumbnails {%- endcomment -%}
    {%- if section.settings.show_navigation -%}
      {%- if blog.previous_article or blog.next_article -%}
        <nav class="article-navigation article-navigation--enhanced" aria-label="{{ 'article.navigation' | t }}">
          {%- if blog.previous_article -%}
            <a href="{{ blog.previous_article.url }}" class="article-navigation__link article-navigation__link--prev">
              {%- if blog.previous_article.image -%}
                <div class="article-navigation__image">
                  {{
                    blog.previous_article.image
                    | image_url: width: 200
                    | image_tag:
                      loading: 'lazy',
                      widths: '80, 120, 160, 200',
                      sizes: '80px',
                      class: 'article-navigation__thumbnail'
                  }}
                </div>
              {%- endif -%}
              <span class="article-navigation__content">
                <span class="article-navigation__direction">
                  {% render 'icon', icon: 'arrow-left', size: 'sm' %}
                  <span class="article-navigation__label">{{ 'article.previous' | t }}</span>
                </span>
                <span class="article-navigation__title">{{ blog.previous_article.title | truncate: 60 }}</span>
              </span>
            </a>
          {%- else -%}
            <div class="article-navigation__placeholder"></div>
          {%- endif -%}

          {%- if blog.next_article -%}
            <a href="{{ blog.next_article.url }}" class="article-navigation__link article-navigation__link--next">
              <span class="article-navigation__content">
                <span class="article-navigation__direction">
                  <span class="article-navigation__label">{{ 'article.next' | t }}</span>
                  {% render 'icon', icon: 'arrow-right', size: 'sm' %}
                </span>
                <span class="article-navigation__title">{{ blog.next_article.title | truncate: 60 }}</span>
              </span>
              {%- if blog.next_article.image -%}
                <div class="article-navigation__image">
                  {{
                    blog.next_article.image
                    | image_url: width: 200
                    | image_tag:
                      loading: 'lazy',
                      widths: '80, 120, 160, 200',
                      sizes: '80px',
                      class: 'article-navigation__thumbnail'
                  }}
                </div>
              {%- endif -%}
            </a>
          {%- else -%}
            <div class="article-navigation__placeholder"></div>
          {%- endif -%}
        </nav>
      {%- endif -%}
    {%- endif -%}

    {%- comment -%} Related Articles {%- endcomment -%}
    {%- if section.settings.show_related_articles -%}
      {% render 'related-articles', article: article, blog: blog, limit: 3 %}
    {%- endif -%}

    {%- comment -%} Comments {%- endcomment -%}
    {%- if blog.comments_enabled? -%}
      <div class="article-comments" id="comments">
        <h2 class="article-comments__heading h3">
          {{ 'blog.comments.title' | t: count: article.comments_count }}
        </h2>

        {%- if article.comments_count > 0 -%}
          {%- paginate article.comments by 10 -%}
            <div class="article-comments__list">
              {%- for comment in article.comments -%}
                <div class="article-comment" id="comment-{{ comment.id }}">
                  <div class="article-comment__header">
                    <span class="article-comment__author">{{ comment.author }}</span>
                    <time class="article-comment__date" datetime="{{ comment.created_at | date: '%Y-%m-%d' }}">
                      {{ comment.created_at | date: format: 'abbreviated_date' }}
                    </time>
                  </div>
                  <div class="article-comment__content">
                    {{ comment.content }}
                  </div>
                </div>
              {%- endfor -%}
            </div>

            {%- if paginate.pages > 1 -%}
              <nav class="pagination" aria-label="{{ 'accessibility.pagination' | t }}">
                <ul class="pagination__list">
                  {%- if paginate.previous -%}
                    <li class="pagination__item">
                      <a href="{{ paginate.previous.url }}#comments" class="pagination__link">
                        {{ 'pagination.previous' | t }}
                      </a>
                    </li>
                  {%- endif -%}
                  {%- if paginate.next -%}
                    <li class="pagination__item">
                      <a href="{{ paginate.next.url }}#comments" class="pagination__link">
                        {{ 'pagination.next' | t }}
                      </a>
                    </li>
                  {%- endif -%}
                </ul>
              </nav>
            {%- endif -%}
          {%- endpaginate -%}
        {%- endif -%}

        {%- comment -%} Comment Form {%- endcomment -%}
        <div class="article-comment-form">
          <h3 class="article-comment-form__heading h4">{{ 'blog.comments.leave_comment' | t }}</h3>

          {%- form 'new_comment', article -%}
            {%- if form.posted_successfully? -%}
              <div class="form-message form-message--success">
                {%- if blog.moderated? -%}
                  {{ 'blog.comments.success_moderated' | t }}
                {%- else -%}
                  {{ 'blog.comments.success' | t }}
                {%- endif -%}
              </div>
            {%- endif -%}

            {%- if form.errors -%}
              <div class="form-message form-message--error">
                {{ form.errors | default_errors }}
              </div>
            {%- endif -%}

            <div class="form-group">
              <label for="CommentAuthor" class="form-label">{{ 'common.name' | t }}</label>
              <input
                type="text"
                id="CommentAuthor"
                name="comment[author]"
                class="form-input"
                value="{{ form.author }}"
                required
              >
            </div>

            <div class="form-group">
              <label for="CommentEmail" class="form-label">{{ 'common.email' | t }}</label>
              <input
                type="email"
                id="CommentEmail"
                name="comment[email]"
                class="form-input"
                value="{{ form.email }}"
                required
              >
            </div>

            <div class="form-group">
              <label for="CommentBody" class="form-label">{{ 'common.message' | t }}</label>
              <textarea
                id="CommentBody"
                name="comment[body]"
                class="form-input form-textarea"
                rows="5"
                required
              >{{ form.body }}</textarea>
            </div>

            <button type="submit" class="btn btn--filled">
              {{ 'blog.comments.submit' | t }}
            </button>
          {%- endform -%}
        </div>
      </div>
    {%- endif -%}
  </div>
</article>

{% schema %}
{
  "name": "t:sections.main_article.name",
  "tag": "section",
  "class": "section-main-article",
  "settings": [
    {
      "type": "header",
      "content": "t:sections.main_article.settings.header_reading_experience.content"
    },
    {
      "type": "checkbox",
      "id": "show_progress_bar",
      "label": "t:sections.main_article.settings.show_progress_bar.label",
      "info": "t:sections.main_article.settings.show_progress_bar.info",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_read_time",
      "label": "t:sections.main_article.settings.show_read_time.label",
      "info": "t:sections.main_article.settings.show_read_time.info",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_drop_caps",
      "label": "t:sections.main_article.settings.enable_drop_caps.label",
      "info": "t:sections.main_article.settings.enable_drop_caps.info",
      "default": true
    },
    {
      "type": "select",
      "id": "drop_cap_style",
      "label": "t:sections.main_article.settings.drop_cap_style.label",
      "options": [
        {
          "value": "default",
          "label": "t:sections.main_article.settings.drop_cap_style.options.default"
        },
        {
          "value": "serif",
          "label": "t:sections.main_article.settings.drop_cap_style.options.serif"
        },
        {
          "value": "square",
          "label": "t:sections.main_article.settings.drop_cap_style.options.square"
        }
      ],
      "default": "default"
    },
    {
      "type": "header",
      "content": "t:sections.main_article.settings.header_article_display.content"
    },
    {
      "type": "checkbox",
      "id": "show_breadcrumb",
      "label": "t:sections.main_article.settings.show_breadcrumb.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_featured_image",
      "label": "t:sections.main_article.settings.show_featured_image.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_excerpt",
      "label": "t:sections.main_article.settings.show_excerpt.label",
      "info": "t:sections.main_article.settings.show_excerpt.info",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_tags",
      "label": "t:sections.main_article.settings.show_tags.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_date",
      "label": "t:sections.main_article.settings.show_date.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_author",
      "label": "t:sections.main_article.settings.show_author.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_share",
      "label": "t:sections.main_article.settings.show_share.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_author_bio",
      "label": "t:sections.main_article.settings.show_author_bio.label",
      "info": "t:sections.main_article.settings.show_author_bio.info",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "t:sections.main_article.settings.show_navigation.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_related_articles",
      "label": "t:sections.main_article.settings.show_related_articles.label",
      "info": "t:sections.main_article.settings.show_related_articles.info",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:labels.color_scheme",
      "default": "scheme_1"
    }
  ]
}
{% endschema %}
