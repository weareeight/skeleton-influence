{% comment %}
  Main Collection Section - Influence Theme
  Features: Faceted filtering (REQUIRED), sorting, grid/list view, pagination
{% endcomment %}

{%- liquid
  assign sort_by = collection.sort_by | default: collection.default_sort_by
  assign products_per_page = section.settings.products_per_page
  assign columns_desktop = section.settings.columns_desktop
  assign columns_mobile = section.settings.columns_mobile
  assign show_filters = section.settings.show_filters
  assign show_sorting = section.settings.show_sorting
  assign filter_type = section.settings.filter_type
  assign enable_sticky_filters = section.settings.enable_sticky_filters
-%}

<section class="main-collection section{% if filter_type == 'sidebar' %} main-collection--sidebar{% endif %} {% render 'color-scheme', scheme: section.settings.color_scheme %}">
  <div class="container">
    {%- comment -%} Collection Header {%- endcomment -%}
    {%- if section.settings.show_collection_header -%}
      <header class="collection-header">
        {%- if section.settings.show_collection_image and collection.image -%}
          <div class="collection-header__image">
            {{
              collection.image
              | image_url: width: 1920
              | image_tag:
                loading: 'eager',
                sizes: '100vw',
                widths: '375, 750, 1100, 1500, 1920',
                class: 'collection-header__img'
            }}
          </div>
        {%- endif -%}

        <div class="collection-header__content">
          <h1 class="collection-header__title h2">{{ collection.title }}</h1>
          {%- if section.settings.show_description and collection.description != blank -%}
            <div class="collection-header__description rte">
              {{ collection.description }}
            </div>
          {%- endif -%}
        </div>
      </header>
    {%- endif -%}

    {%- comment -%} Toolbar: Filters Toggle, Active Filters, Sorting, View Toggle {%- endcomment -%}
    <div class="collection-toolbar">
      <div class="collection-toolbar__left">
        {%- if show_filters and collection.filters.size > 0 -%}
          <button
            type="button"
            class="collection-toolbar__filter-toggle btn btn--outline btn--sm"
            aria-controls="collection-filters"
            aria-expanded="false"
            data-filter-toggle
          >
            {% render 'icon', icon: 'filter' %}
            <span>{{ 'collection.filters.filter' | t }}</span>
            {%- assign active_filters_count = 0 -%}
            {%- for filter in collection.filters -%}
              {%- assign active_filters_count = active_filters_count | plus: filter.active_values.size -%}
            {%- endfor -%}
            {%- if active_filters_count > 0 -%}
              <span class="collection-toolbar__filter-count">{{ active_filters_count }}</span>
            {%- endif -%}
          </button>
        {%- endif -%}

        {%- comment -%} Active Filter Tags {%- endcomment -%}
        {%- if active_filters_count > 0 -%}
          <div class="collection-active-filters">
            {%- for filter in collection.filters -%}
              {%- for value in filter.active_values -%}
                <a
                  href="{{ value.url_to_remove }}"
                  class="active-filter-tag"
                >
                  {{ filter.label }}: {{ value.label }}
                  {% render 'icon', icon: 'close', size: 'xs' %}
                </a>
              {%- endfor -%}
            {%- endfor -%}
            <a href="{{ collection.url }}?sort_by={{ sort_by }}" class="active-filter-clear">
              {{ 'collection.filters.clear_all' | t }}
            </a>
          </div>
        {%- endif -%}
      </div>

      <div class="collection-toolbar__right">
        {%- comment -%} Product Count {%- endcomment -%}
        <p class="collection-toolbar__count">
          {{ 'collection.products_count' | t: count: collection.products_count }}
        </p>

        {%- comment -%} Sorting {%- endcomment -%}
        {%- if show_sorting -%}
          <div class="collection-toolbar__sort">
            <label for="SortBy" class="visually-hidden">{{ 'collection.sorting.label' | t }}</label>
            <select
              id="SortBy"
              class="collection-sort form-select"
              data-sort-by
            >
              {%- for option in collection.sort_options -%}
                <option
                  value="{{ option.value }}"
                  {% if sort_by == option.value %}selected{% endif %}
                >
                  {{ option.name }}
                </option>
              {%- endfor -%}
            </select>
          </div>
        {%- endif -%}

        {%- comment -%} View Toggle {%- endcomment -%}
        {%- if section.settings.show_view_toggle -%}
          <div class="collection-toolbar__view" role="group" aria-label="{{ 'collection.view.label' | t }}">
            <button
              type="button"
              class="collection-toolbar__view-btn is-active"
              data-view="grid"
              aria-label="{{ 'collection.view.grid' | t }}"
              aria-pressed="true"
            >
              {% render 'icon', icon: 'grid' %}
            </button>
            <button
              type="button"
              class="collection-toolbar__view-btn"
              data-view="list"
              aria-label="{{ 'collection.view.list' | t }}"
              aria-pressed="false"
            >
              {% render 'icon', icon: 'list' %}
            </button>
          </div>
        {%- endif -%}
      </div>
    </div>

    <div class="collection-content{% if filter_type == 'sidebar' %} collection-content--sidebar{% endif %}">
      {%- comment -%} Filters Sidebar / Drawer {%- endcomment -%}
      {%- if show_filters and collection.filters.size > 0 -%}
        <aside
          id="collection-filters"
          class="collection-filters{% if filter_type == 'drawer' %} collection-filters--drawer{% endif %}{% if enable_sticky_filters %} collection-filters--sticky{% endif %}"
          data-filters
          {% if filter_type == 'drawer' %}aria-hidden="true"{% endif %}
        >
          <div class="collection-filters__header">
            <h2 class="collection-filters__title h4">{{ 'collection.filters.filter' | t }}</h2>
            <button
              type="button"
              class="collection-filters__close"
              data-filter-close
              aria-label="{{ 'accessibility.close' | t }}"
            >
              {% render 'icon', icon: 'close' %}
            </button>
          </div>
          {%- if filter_type != 'drawer' -%}
            <h2 class="collection-filters__sidebar-title">{{ 'collection.filters.filter' | t }}</h2>
          {%- endif -%}

          <form id="CollectionFiltersForm" data-collection-filters-form>
            <div class="collection-filters__content">
              {%- for filter in collection.filters -%}
                <details
                  class="collection-filter"
                  {% if filter.active_values.size > 0 or forloop.index <= 3 %}open{% endif %}
                >
                  <summary class="collection-filter__heading">
                    <span>{{ filter.label }}</span>
                    {%- if filter.active_values.size > 0 -%}
                      <span class="collection-filter__count">({{ filter.active_values.size }})</span>
                    {%- endif -%}
                    {% render 'icon', icon: 'chevron-down', size: 'sm' %}
                  </summary>

                  <div class="collection-filter__content">
                    {%- case filter.type -%}
                      {%- when 'list' -%}
                        <ul class="collection-filter__list" role="list">
                          {%- for value in filter.values -%}
                            <li class="collection-filter__item">
                              <label class="collection-filter__label">
                                <input
                                  type="checkbox"
                                  name="{{ value.param_name }}"
                                  value="{{ value.value }}"
                                  {% if value.active %}checked{% endif %}
                                  {% if value.count == 0 and value.active == false %}disabled{% endif %}
                                  class="collection-filter__checkbox"
                                  data-filter-input
                                >
                                <span class="collection-filter__checkbox-visual"></span>
                                <span class="collection-filter__text">
                                  {%- if filter.param_name == 'filter.v.option.color' or filter.param_name contains 'filter.v.option.colour' -%}
                                    <span
                                      class="collection-filter__swatch"
                                      style="--swatch-color: {{ value.value | handle | replace: '-', '' }}"
                                    ></span>
                                  {%- endif -%}
                                  {{ value.label }}
                                </span>
                                <span class="collection-filter__count">({{ value.count }})</span>
                              </label>
                            </li>
                          {%- endfor -%}
                        </ul>

                      {%- when 'price_range' -%}
                        <div class="collection-filter__price-range">
                          <div class="collection-filter__price-inputs">
                            <div class="collection-filter__price-field">
                              <label for="Filter-{{ filter.param_name }}-GTE">{{ 'collection.filters.from' | t }}</label>
                              <span class="collection-filter__price-currency">{{ cart.currency.symbol }}</span>
                              <input
                                type="number"
                                id="Filter-{{ filter.param_name }}-GTE"
                                name="{{ filter.min_value.param_name }}"
                                class="form-input collection-filter__price-input"
                                min="0"
                                max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                                {% if filter.min_value.value %}
                                  value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"
                                {% endif %}
                                placeholder="0"
                                data-filter-input
                              >
                            </div>
                            <span class="collection-filter__price-separator">â€”</span>
                            <div class="collection-filter__price-field">
                              <label for="Filter-{{ filter.param_name }}-LTE">{{ 'collection.filters.to' | t }}</label>
                              <span class="collection-filter__price-currency">{{ cart.currency.symbol }}</span>
                              <input
                                type="number"
                                id="Filter-{{ filter.param_name }}-LTE"
                                name="{{ filter.max_value.param_name }}"
                                class="form-input collection-filter__price-input"
                                min="0"
                                max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                                {% if filter.max_value.value %}
                                  value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"
                                {% endif %}
                                placeholder="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                                data-filter-input
                              >
                            </div>
                          </div>
                        </div>

                      {%- when 'boolean' -%}
                        <label class="collection-filter__label collection-filter__label--boolean">
                          <input
                            type="checkbox"
                            name="{{ filter.param_name }}"
                            value="1"
                            {% if filter.active_values.size > 0 %}checked{% endif %}
                            class="collection-filter__checkbox"
                            data-filter-input
                          >
                          <span class="collection-filter__checkbox-visual"></span>
                          <span class="collection-filter__text">{{ filter.label }}</span>
                        </label>
                    {%- endcase -%}
                  </div>
                </details>
              {%- endfor -%}
            </div>

            {%- comment -%} Filter Actions (always rendered, CSS controls visibility) {%- endcomment -%}
            <div class="collection-filters__actions">
              <a href="{{ collection.url }}" class="btn btn--outline btn--full">
                {{ 'collection.filters.clear' | t }}
              </a>
              <button type="submit" class="btn btn--filled btn--full">
                {{ 'collection.filters.apply' | t }}
              </button>
            </div>

            <noscript>
              <button type="submit" class="btn btn--filled">
                {{ 'collection.filters.apply' | t }}
              </button>
            </noscript>
          </form>
        </aside>

        <div class="collection-filters__overlay" data-filter-overlay></div>
      {%- endif -%}

      {%- comment -%} Products Grid {%- endcomment -%}
      <div class="collection-products" data-products-container>
        {%- paginate collection.products by products_per_page -%}
          {%- if collection.products.size > 0 -%}
            <div
              class="collection-products__grid"
              style="--grid-columns-desktop: {{ columns_desktop }}; --grid-columns-mobile: {{ columns_mobile }};"
              data-products-grid
            >
              {%- for product in collection.products -%}
                {%- assign card_delay = forloop.index0 | times: 50 | plus: 100 -%}
                <div class="collection-products__item" data-animate="fade" style="--delay: {{ card_delay }}ms">
                  {% render 'product-card', product: product %}
                </div>
              {%- endfor -%}
            </div>

            {%- comment -%} Pagination {%- endcomment -%}
            {%- if paginate.pages > 1 -%}
              <nav class="pagination" aria-label="{{ 'accessibility.pagination' | t }}">
                <ul class="pagination__list">
                  {%- if paginate.previous -%}
                    <li class="pagination__item">
                      <a href="{{ paginate.previous.url }}" class="pagination__link pagination__link--prev" aria-label="{{ 'accessibility.previous_page' | t }}">
                        {% render 'icon', icon: 'chevron-left', size: 'sm' %}
                        <span class="hide-mobile">{{ 'pagination.previous' | t }}</span>
                      </a>
                    </li>
                  {%- endif -%}

                  {%- for part in paginate.parts -%}
                    <li class="pagination__item">
                      {%- if part.is_link -%}
                        <a href="{{ part.url }}" class="pagination__link">
                          {{ part.title }}
                        </a>
                      {%- else -%}
                        {%- if part.title == paginate.current_page -%}
                          <span class="pagination__link pagination__link--current" aria-current="page">
                            {{ part.title }}
                          </span>
                        {%- else -%}
                          <span class="pagination__link pagination__link--ellipsis">{{ part.title }}</span>
                        {%- endif -%}
                      {%- endif -%}
                    </li>
                  {%- endfor -%}

                  {%- if paginate.next -%}
                    <li class="pagination__item">
                      <a href="{{ paginate.next.url }}" class="pagination__link pagination__link--next" aria-label="{{ 'accessibility.next_page' | t }}">
                        <span class="hide-mobile">{{ 'pagination.next' | t }}</span>
                        {% render 'icon', icon: 'chevron-right', size: 'sm' %}
                      </a>
                    </li>
                  {%- endif -%}
                </ul>
              </nav>
            {%- endif -%}
          {%- else -%}
            <div class="collection-empty">
              <p>{{ 'collection.empty' | t }}</p>
              {%- if active_filters_count > 0 -%}
                <a href="{{ collection.url }}" class="btn btn--outline">
                  {{ 'collection.filters.clear_all' | t }}
                </a>
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endpaginate -%}
      </div>
    </div>
  </div>
</section>

<script>
(function() {
  const filterToggle = document.querySelector('[data-filter-toggle]');
  const filtersContainer = document.querySelector('[data-filters]');
  const filterClose = document.querySelector('[data-filter-close]');
  const filterOverlay = document.querySelector('[data-filter-overlay]');
  const filterForm = document.querySelector('[data-collection-filters-form]');
  const filterInputs = document.querySelectorAll('[data-filter-input]');
  const sortSelect = document.querySelector('[data-sort-by]');
  const viewButtons = document.querySelectorAll('[data-view]');
  const productsGrid = document.querySelector('[data-products-grid]');

  // Filter toggle (for drawer mode)
  if (filterToggle && filtersContainer) {
    filterToggle.addEventListener('click', () => {
      const isOpen = filtersContainer.classList.contains('is-open');
      filtersContainer.classList.toggle('is-open');
      filtersContainer.setAttribute('aria-hidden', isOpen);
      filterToggle.setAttribute('aria-expanded', !isOpen);
      document.body.classList.toggle('filters-open', !isOpen);
    });
  }

  if (filterClose) {
    filterClose.addEventListener('click', closeFilters);
  }

  if (filterOverlay) {
    filterOverlay.addEventListener('click', closeFilters);
  }

  function closeFilters() {
    if (filtersContainer) {
      filtersContainer.classList.remove('is-open');
      filtersContainer.setAttribute('aria-hidden', 'true');
      if (filterToggle) {
        filterToggle.setAttribute('aria-expanded', 'false');
      }
      document.body.classList.remove('filters-open');
    }
  }

  // Auto-submit filters on change (sidebar mode)
  filterInputs.forEach(input => {
    input.addEventListener('change', () => {
      if (!filtersContainer.classList.contains('collection-filters--drawer')) {
        filterForm.submit();
      }
    });
  });

  // Sort change
  if (sortSelect) {
    sortSelect.addEventListener('change', () => {
      const url = new URL(window.location.href);
      url.searchParams.set('sort_by', sortSelect.value);
      window.location.href = url.toString();
    });
  }

  // View toggle
  viewButtons.forEach(button => {
    button.addEventListener('click', () => {
      const view = button.dataset.view;

      viewButtons.forEach(btn => {
        btn.classList.remove('is-active');
        btn.setAttribute('aria-pressed', 'false');
      });

      button.classList.add('is-active');
      button.setAttribute('aria-pressed', 'true');

      if (productsGrid) {
        productsGrid.classList.remove('grid--list', 'grid--grid');
        productsGrid.classList.add(`grid--${view}`);
      }

      // Save preference
      localStorage.setItem('collection-view', view);
    });
  });

  // Restore view preference
  const savedView = localStorage.getItem('collection-view');
  if (savedView && productsGrid) {
    const savedButton = document.querySelector(`[data-view="${savedView}"]`);
    if (savedButton) {
      savedButton.click();
    }
  }

  // Close filters on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeFilters();
    }
  });
})();
</script>

{% stylesheet %}
  /* ========================================
     Collection Header
     ======================================== */
  .collection-header {
    margin-bottom: var(--space-8);
  }

  .collection-header__image {
    position: relative;
    aspect-ratio: 21 / 9;
    overflow: hidden;
    margin-bottom: var(--space-6);
  }

  .collection-header__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .collection-header__content {
    text-align: center;
    max-width: 48rem;
    margin-inline: auto;
  }

  .collection-header__title {
    margin-bottom: var(--space-2);
  }

  .collection-header__description {
    color: var(--color-foreground-muted);
  }

  /* ========================================
     Toolbar
     ======================================== */
  .collection-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    padding-bottom: var(--space-6);
    margin-bottom: var(--space-6);
    border-bottom: var(--border-width) solid var(--color-border);
  }

  .collection-toolbar__left {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-3);
  }

  .collection-toolbar__right {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-4);
  }

  .collection-toolbar__filter-toggle {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
  }

  .collection-toolbar__filter-toggle svg {
    transition: transform var(--duration-short) var(--ease-out);
  }

  .collection-toolbar__filter-toggle:hover svg {
    transform: scale(1.1);
  }

  .collection-toolbar__filter-count {
    font-size: var(--font-size-xs);
    background: var(--color-foreground);
    color: var(--color-background);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-full);
    min-width: 1.25rem;
    text-align: center;
  }

  .collection-toolbar__count {
    font-size: var(--font-size-xs);
    color: var(--color-foreground-muted);
    margin: 0;
    letter-spacing: 0.02em;
  }

  .collection-toolbar__sort {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .collection-toolbar__view {
    display: flex;
    gap: var(--space-1);
  }

  .collection-toolbar__view-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--touch-target-min);
    height: var(--touch-target-min);
    border: var(--border-width) solid var(--color-border);
    border-radius: var(--radius-sm);
    background: transparent;
    color: var(--color-foreground-muted);
    cursor: pointer;
    transition: all var(--duration-short) var(--ease-out);
  }

  .collection-toolbar__view-btn:hover,
  .collection-toolbar__view-btn.is-active {
    background: var(--color-foreground);
    color: var(--color-background);
    border-color: var(--color-foreground);
  }

  /* ========================================
     Active Filter Tags
     ======================================== */
  .collection-active-filters {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-2);
  }

  .active-filter-tag {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-1) var(--space-2) var(--space-1) var(--space-3);
    font-size: var(--font-size-xs);
    background: var(--color-foreground);
    color: var(--color-background);
    border-radius: var(--radius-full);
    text-decoration: none;
    transition: all var(--duration-short) var(--ease-out);
  }

  .active-filter-tag:hover {
    background: var(--color-foreground-muted);
  }

  .active-filter-tag svg {
    opacity: 0.7;
    transition: opacity var(--duration-short) var(--ease-out);
  }

  .active-filter-tag:hover svg {
    opacity: 1;
  }

  .active-filter-clear {
    font-size: var(--font-size-xs);
    color: var(--color-foreground-muted);
    text-decoration: underline;
    text-underline-offset: 0.2em;
    transition: color var(--duration-short) var(--ease-out);
  }

  .active-filter-clear:hover {
    color: var(--color-foreground);
  }

  /* ========================================
     Content Layout
     ======================================== */
  .collection-content {
    position: relative;
    display: block;
    width: 100%;
  }

  /* Layout when sidebar is active - sidebar is fixed to left edge */
  .collection-content--sidebar {
    display: block;
  }

  /* Hide filter toggle on desktop when sidebar is visible */
  @media (min-width: 990px) {
    .main-collection--sidebar .collection-toolbar__filter-toggle {
      display: none;
    }
  }

  @media (max-width: 989px) {
    .collection-content--sidebar {
      display: block;
    }

    /* Hide sidebar on mobile, show filter toggle instead */
    .collection-content--sidebar .collection-filters:not(.collection-filters--drawer) {
      display: none;
    }
  }

  /* Products container - stacks children vertically */
  .collection-products {
    display: flex;
    flex-direction: column;
    width: 100%;
  }

  /* ========================================
     Filter Sidebar (fixed to left edge)
     ======================================== */
  @media (min-width: 990px) {
    .collection-filters:not(.collection-filters--drawer) {
      position: fixed;
      left: 0;
      top: var(--header-height, 4rem);
      width: 14rem;
      height: calc(100vh - var(--header-height, 4rem));
      height: calc(100dvh - var(--header-height, 4rem));
      background: var(--color-background);
      border-right: var(--border-width) solid var(--color-border);
      overflow-y: auto;
      z-index: calc(var(--z-header) - 1);
      padding: var(--space-6) var(--space-4);
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    .collection-filters:not(.collection-filters--drawer)::-webkit-scrollbar {
      width: 4px;
    }

    .collection-filters:not(.collection-filters--drawer)::-webkit-scrollbar-track {
      background: transparent;
    }

    .collection-filters:not(.collection-filters--drawer)::-webkit-scrollbar-thumb {
      background-color: var(--color-border);
      border-radius: 2px;
    }

    /* Offset main content to account for fixed sidebar */
    .main-collection--sidebar .container {
      margin-left: 14rem;
      max-width: calc(var(--container-max-width) - 14rem);
    }
  }

  /* Sidebar-specific content styling (without drawer chrome) */
  .collection-filters:not(.collection-filters--drawer) .collection-filters__content {
    padding: 0;
    overflow: visible;
  }

  /* Hide drawer header on desktop for sidebar mode */
  .collection-filters:not(.collection-filters--drawer) .collection-filters__header {
    display: none;
  }

  /* Sidebar title styling (desktop only) */
  .collection-filters__sidebar-title {
    margin: 0 0 var(--space-4);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    letter-spacing: var(--letter-spacing-wide);
    text-transform: uppercase;
    color: var(--color-foreground-muted);
  }

  /* Remove top border on first filter in sidebar (cleaner look) */
  .collection-filters:not(.collection-filters--drawer) .collection-filter:first-child {
    border-top: none;
  }

  /* Hide actions on desktop for sidebar mode (filters auto-submit) */
  .collection-filters:not(.collection-filters--drawer) .collection-filters__actions {
    display: none;
  }

  /* Mobile: Sidebar transforms to drawer behavior */
  @media (max-width: 989px) {
    .collection-filters:not(.collection-filters--drawer) {
      position: fixed;
      top: 0;
      left: 0;
      z-index: var(--z-modal);
      display: flex;
      flex-direction: column;
      width: min(100vw, 26rem);
      height: 100vh;
      height: 100dvh;
      background: var(--color-background);
      box-shadow: 4px 0 24px rgb(0 0 0 / 0.1);
      transform: translateX(-100%);
      transition: transform var(--duration-normal) var(--ease-elegant);
      visibility: hidden;
    }

    .collection-filters:not(.collection-filters--drawer).is-open {
      transform: translateX(0);
      visibility: visible;
    }

    /* Show drawer header on mobile */
    .collection-filters:not(.collection-filters--drawer) .collection-filters__header {
      display: flex;
    }

    /* Hide sidebar title on mobile (header shows instead) */
    .collection-filters:not(.collection-filters--drawer) .collection-filters__sidebar-title {
      display: none;
    }

    /* Restore content padding for drawer behavior */
    .collection-filters:not(.collection-filters--drawer) .collection-filters__content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-2) var(--space-6);
      min-height: 0;
    }

    /* Show overlay on mobile when sidebar opens */
    .collection-filters:not(.collection-filters--drawer).is-open ~ .collection-filters__overlay {
      opacity: 1;
      visibility: visible;
    }

    /* Show actions on mobile for sidebar mode (acts as drawer) */
    .collection-filters:not(.collection-filters--drawer) .collection-filters__actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-3);
      padding: var(--space-6);
      border-top: var(--border-width) solid var(--color-border);
      background: var(--color-background);
    }
  }

  /* ========================================
     Filter Drawer (slide-in)
     ======================================== */
  .collection-filters--drawer {
    position: fixed;
    top: 0;
    left: 0;
    z-index: var(--z-modal);
    display: flex;
    flex-direction: column;
    width: min(100vw, 26rem);
    height: 100vh;
    height: 100dvh;
    background: var(--color-background);
    box-shadow: 4px 0 24px rgb(0 0 0 / 0.1);
    transform: translateX(-100%);
    transition: transform var(--duration-normal) var(--ease-elegant);
    visibility: hidden;
  }

  .collection-filters--drawer.is-open {
    transform: translateX(0);
    visibility: visible;
  }

  .collection-filters__overlay {
    position: fixed;
    inset: 0;
    z-index: calc(var(--z-modal) - 1);
    background: rgb(0 0 0 / 0.4);
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--duration-normal) var(--ease-out),
                visibility var(--duration-normal) var(--ease-out);
  }

  .collection-filters--drawer.is-open ~ .collection-filters__overlay {
    opacity: 1;
    visibility: visible;
  }

  .collection-filters__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-6);
    border-bottom: var(--border-width) solid var(--color-border);
  }

  .collection-filters__title {
    margin: 0;
    font-size: var(--font-size-sm);
    letter-spacing: var(--letter-spacing-wide);
    text-transform: uppercase;
  }

  .collection-filters__close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--touch-target-min);
    height: var(--touch-target-min);
    margin-right: calc(var(--space-2) * -1);
    background: transparent;
    border: none;
    border-radius: var(--radius-full);
    cursor: pointer;
    color: var(--color-foreground);
    transition: background-color var(--duration-short) var(--ease-out);
  }

  .collection-filters__close:hover {
    background-color: var(--color-muted);
  }

  /* Form needs to be a flex container to enable scrolling */
  .collection-filters--drawer form {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0; /* Critical for flex child scrolling */
  }

  .collection-filters__content {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-2) var(--space-6);
    min-height: 0; /* Critical for flex child scrolling */
    scrollbar-width: thin;
    scrollbar-color: var(--color-border) transparent;
  }

  .collection-filters__content::-webkit-scrollbar {
    width: 6px;
  }

  .collection-filters__content::-webkit-scrollbar-track {
    background: transparent;
  }

  .collection-filters__content::-webkit-scrollbar-thumb {
    background-color: var(--color-border);
    border-radius: 3px;
  }

  .collection-filters__actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-3);
    padding: var(--space-6);
    border-top: var(--border-width) solid var(--color-border);
    background: var(--color-background);
  }

  /* ========================================
     Filter Groups (Accordion)
     ======================================== */
  .collection-filter {
    border-bottom: var(--border-width) solid var(--color-border);
  }

  .collection-filter:first-child {
    border-top: var(--border-width) solid var(--color-border);
  }

  .collection-filter__heading {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: var(--space-5) 0;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    letter-spacing: 0.02em;
    cursor: pointer;
    list-style: none;
    transition: color var(--duration-short) var(--ease-out);
  }

  .collection-filter__heading:hover {
    color: var(--color-foreground-muted);
  }

  .collection-filter__heading::-webkit-details-marker {
    display: none;
  }

  .collection-filter__heading svg {
    flex-shrink: 0;
    opacity: 0.5;
    transition: transform var(--duration-short) var(--ease-out),
                opacity var(--duration-short) var(--ease-out);
  }

  .collection-filter__heading:hover svg {
    opacity: 1;
  }

  .collection-filter[open] .collection-filter__heading svg {
    transform: rotate(180deg);
    opacity: 1;
  }

  .collection-filter__count {
    font-size: var(--font-size-xs);
    color: var(--color-background);
    background: var(--color-foreground);
    font-weight: normal;
    margin-left: var(--space-2);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-full);
  }

  .collection-filter__content {
    padding-bottom: var(--space-5);
  }

  /* Filter List (Checkboxes) */
  .collection-filter__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .collection-filter__item {
    margin: 0;
  }

  .collection-filter__label {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) 0;
    cursor: pointer;
    transition: opacity var(--duration-short) var(--ease-out);
  }

  .collection-filter__label:hover {
    opacity: 0.7;
  }

  .collection-filter__label:has(input:disabled) {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .collection-filter__label:has(input:disabled):hover {
    opacity: 0.35;
  }

  .collection-filter__checkbox {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .collection-filter__checkbox-visual {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.125rem;
    height: 1.125rem;
    border: 1.5px solid var(--color-foreground);
    border-radius: 2px;
    background: transparent;
    flex-shrink: 0;
    transition: all var(--duration-short) var(--ease-out);
  }

  .collection-filter__checkbox:checked + .collection-filter__checkbox-visual {
    background: var(--color-foreground);
    border-color: var(--color-foreground);
  }

  .collection-filter__checkbox:checked + .collection-filter__checkbox-visual::after {
    content: '';
    width: 0.375rem;
    height: 0.1875rem;
    border-left: 1.5px solid var(--color-background);
    border-bottom: 1.5px solid var(--color-background);
    transform: rotate(-45deg) translateY(-1px);
  }

  .collection-filter__checkbox:focus-visible + .collection-filter__checkbox-visual {
    outline: 2px solid var(--color-foreground);
    outline-offset: 2px;
  }

  .collection-filter__text {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex: 1;
    font-size: var(--font-size-sm);
  }

  .collection-filter__label .collection-filter__count {
    background: transparent;
    color: var(--color-foreground-muted);
    padding: 0;
    font-size: var(--font-size-xs);
  }

  /* Color Swatches */
  .collection-filter__swatch {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
    border-radius: var(--radius-full);
    background-color: var(--swatch-color, #ccc);
    border: 1.5px solid var(--color-border);
    box-shadow: inset 0 0 0 1px rgb(255 255 255 / 0.2);
  }

  /* Price Range */
  .collection-filter__price-range {
    padding-top: var(--space-3);
  }

  .collection-filter__price-inputs {
    display: flex;
    align-items: flex-end;
    gap: var(--space-3);
  }

  .collection-filter__price-field {
    flex: 1;
    position: relative;
  }

  .collection-filter__price-field label {
    display: block;
    font-size: var(--font-size-xs);
    color: var(--color-foreground-muted);
    margin-bottom: var(--space-2);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .collection-filter__price-currency {
    position: absolute;
    left: var(--space-3);
    bottom: 0.875rem;
    font-size: var(--font-size-sm);
    color: var(--color-foreground-muted);
    pointer-events: none;
  }

  .collection-filter__price-input {
    width: 100%;
    padding-left: var(--space-6);
    font-size: var(--font-size-sm);
    height: 2.75rem;
  }

  .collection-filter__price-separator {
    color: var(--color-foreground-muted);
    padding-bottom: 0.875rem;
    font-size: var(--font-size-sm);
  }

  /* ========================================
     Products Grid
     ======================================== */
  .collection-products__grid {
    display: grid;
    gap: var(--grid-gap-md);
    grid-template-columns: repeat(var(--grid-columns-mobile, 2), 1fr);
  }

  @media (min-width: 750px) {
    .collection-products__grid {
      grid-template-columns: repeat(var(--grid-columns-desktop, 4), 1fr);
    }
  }

  /* List View */
  .collection-products__grid.grid--list {
    grid-template-columns: 1fr;
    gap: var(--space-6);
  }

  .collection-products__grid.grid--list .product-card {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: var(--space-6);
    align-items: start;
  }

  @media (min-width: 750px) {
    .collection-products__grid.grid--list .product-card {
      grid-template-columns: 280px 1fr;
    }
  }

  /* ========================================
     Pagination
     ======================================== */
  .pagination {
    margin-top: var(--space-12);
    padding-top: var(--space-8);
    border-top: var(--border-width) solid var(--color-border);
  }

  .pagination__list {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-1);
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .pagination__link {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: var(--touch-target-min);
    height: var(--touch-target-min);
    padding: 0 var(--space-3);
    font-size: var(--font-size-sm);
    text-decoration: none;
    color: var(--color-foreground);
    border-radius: var(--radius-sm);
    transition: all var(--duration-short) var(--ease-out);
  }

  .pagination__link:hover {
    background: var(--color-foreground);
    color: var(--color-background);
  }

  .pagination__link--current {
    background: var(--color-foreground);
    color: var(--color-background);
  }

  .pagination__link--ellipsis {
    pointer-events: none;
  }

  .pagination__link--prev,
  .pagination__link--next {
    gap: var(--space-1);
  }

  /* ========================================
     Empty State
     ======================================== */
  .collection-empty {
    text-align: center;
    padding: var(--space-16) var(--space-4);
  }

  .collection-empty p {
    margin-bottom: var(--space-4);
    color: var(--color-foreground-muted);
  }

  /* ========================================
     Responsive
     ======================================== */
  @media (max-width: 749px) {
    .collection-header__image {
      aspect-ratio: 16 / 9;
      margin-inline: calc(var(--page-margin) * -1);
    }

    .collection-toolbar {
      flex-direction: column;
      align-items: stretch;
    }

    .collection-toolbar__left,
    .collection-toolbar__right {
      justify-content: space-between;
    }

    .collection-toolbar__count {
      order: -1;
    }

    .hide-mobile {
      display: none;
    }
  }

  /* Body scroll lock when filters open */
  body.filters-open {
    overflow: hidden;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:sections.main_collection.name",
  "tag": "section",
  "class": "section-main-collection",
  "settings": [
    {
      "type": "header",
      "content": "t:sections.main_collection.settings.header_collection.content"
    },
    {
      "type": "checkbox",
      "id": "show_collection_header",
      "label": "t:sections.main_collection.settings.show_collection_header.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_collection_image",
      "label": "t:sections.main_collection.settings.show_collection_image.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "t:sections.main_collection.settings.show_description.label",
      "default": true
    },
    {
      "type": "header",
      "content": "t:sections.main_collection.settings.header_filtering.content"
    },
    {
      "type": "checkbox",
      "id": "show_filters",
      "label": "t:sections.main_collection.settings.show_filters.label",
      "info": "t:sections.main_collection.settings.show_filters.info",
      "default": true
    },
    {
      "type": "select",
      "id": "filter_type",
      "label": "t:sections.main_collection.settings.filter_type.label",
      "options": [
        { "value": "sidebar", "label": "t:sections.main_collection.settings.filter_type.options.sidebar" },
        { "value": "drawer", "label": "t:sections.main_collection.settings.filter_type.options.drawer" }
      ],
      "default": "drawer"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_filters",
      "label": "t:sections.main_collection.settings.enable_sticky_filters.label",
      "default": true
    },
    {
      "type": "header",
      "content": "t:sections.main_collection.settings.header_sorting.content"
    },
    {
      "type": "checkbox",
      "id": "show_sorting",
      "label": "t:sections.main_collection.settings.show_sorting.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_view_toggle",
      "label": "t:sections.main_collection.settings.show_view_toggle.label",
      "default": true
    },
    {
      "type": "header",
      "content": "t:sections.main_collection.settings.header_products.content"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "t:sections.main_collection.settings.products_per_page.label",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 16
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "t:labels.columns_desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "t:labels.columns_mobile",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ],
      "default": "2"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:labels.color_scheme",
      "default": "scheme_1"
    }
  ]
}
{% endschema %}
