{% comment %}
  Newsletter Popup Section - Elle Theme
  Features:
  - Centered modal with split layout (image + form)
  - Sweep/reveal animation for image
  - Staggered fade animations for content
  - Cookie persistence for "show once"
  - Configurable delay timer
{% endcomment %}

{%- liquid
  assign section_id = section.id
  assign enable_popup = section.settings.enable_popup
  assign delay_seconds = section.settings.delay_seconds | default: 5
  assign cookie_days = section.settings.cookie_days | default: 30
  assign show_on_mobile = section.settings.show_on_mobile
  assign image_position = section.settings.image_position

  # Determine reveal direction based on image position
  assign image_reveal = 'reveal'
  if image_position == 'right'
    assign image_reveal = 'reveal-right'
  endif
-%}

{%- if enable_popup -%}
  {%- comment -%} Overlay backdrop {%- endcomment -%}
  <div
    class="popup-overlay"
    data-popup-overlay
    aria-hidden="true"
  ></div>

  {%- comment -%} Modal container {%- endcomment -%}
  <div
    class="popup-modal {% render 'color-scheme', scheme: section.settings.color_scheme %}{% unless show_on_mobile %} popup-modal--hide-mobile{% endunless %}"
    id="popup-{{ section_id }}"
    data-popup
    data-section-id="{{ section_id }}"
    data-delay="{{ delay_seconds }}"
    data-cookie-days="{{ cookie_days }}"
    role="dialog"
    aria-modal="true"
    aria-labelledby="popup-heading-{{ section_id }}"
    aria-hidden="true"
  >
    {%- comment -%} Close button {%- endcomment -%}
    <button
      type="button"
      class="popup__close"
      data-popup-close
      aria-label="{{ 'common.close' | t }}"
    >
      {% render 'icon', icon: 'close' %}
    </button>

    {%- comment -%} Split layout container {%- endcomment -%}
    <div class="popup__inner{% if image_position == 'right' %} popup__inner--reverse{% endif %}">
      {%- comment -%} Image side with reveal animation {%- endcomment -%}
      {%- if section.settings.image != blank -%}
        <div class="popup__media" data-animate="{{ image_reveal }}" data-popup-animate>
          {{
            section.settings.image
            | image_url: width: 800
            | image_tag:
              loading: 'eager',
              sizes: '(min-width: 750px) 450px, 100vw',
              widths: '375, 550, 750, 800',
              class: 'popup__image'
          }}
        </div>
      {%- else -%}
        <div class="popup__media popup__media--placeholder" data-animate="{{ image_reveal }}" data-popup-animate>
          {{ 'image' | placeholder_svg_tag: 'popup__placeholder' }}
        </div>
      {%- endif -%}

      {%- comment -%} Content side with staggered animations {%- endcomment -%}
      <div class="popup__content">
        <div class="popup__content-inner">
          {%- assign animation_index = 0 -%}

          {%- if section.settings.subheading != blank -%}
            {%- assign animation_delay = animation_index | times: 100 | plus: 200 -%}
            <p
              class="popup__subheading subheading"
              data-animate="fade"
              data-popup-animate
              style="--delay: {{ animation_delay }}ms"
            >
              {{ section.settings.subheading }}
            </p>
            {%- assign animation_index = animation_index | plus: 1 -%}
          {%- endif -%}

          {%- if section.settings.heading != blank -%}
            {%- assign animation_delay = animation_index | times: 100 | plus: 200 -%}
            <h2
              class="popup__heading h2"
              id="popup-heading-{{ section_id }}"
              data-animate
              data-popup-animate
              style="--delay: {{ animation_delay }}ms"
            >
              {{ section.settings.heading }}
            </h2>
            {%- assign animation_index = animation_index | plus: 1 -%}
          {%- endif -%}

          {%- if section.settings.text != blank -%}
            {%- assign animation_delay = animation_index | times: 100 | plus: 200 -%}
            <div
              class="popup__text rte"
              data-animate
              data-popup-animate
              style="--delay: {{ animation_delay }}ms"
            >
              {{ section.settings.text }}
            </div>
            {%- assign animation_index = animation_index | plus: 1 -%}
          {%- endif -%}

          {%- comment -%} Newsletter form {%- endcomment -%}
          {%- assign animation_delay = animation_index | times: 100 | plus: 200 -%}
          <div
            class="popup__form-wrapper"
            data-animate="fade"
            data-popup-animate
            style="--delay: {{ animation_delay }}ms"
          >
            {%- form 'customer', id: 'PopupNewsletterForm', class: 'popup-form' -%}
              <input type="hidden" name="contact[tags]" value="newsletter,popup">

              {%- if form.posted_successfully? -%}
                <div class="form-message form-message--success" tabindex="-1" autofocus>
                  {% render 'icon', icon: 'checkmark' %}
                  {{ 'newsletter.success' | t }}
                </div>
              {%- else -%}
                {%- if form.errors -%}
                  <div class="form-message form-message--error" role="alert" aria-live="polite" id="Popup-error-{{ section_id }}">
                    {{ form.errors.messages['email'] }}
                  </div>
                {%- endif -%}

                <div class="popup-form__field">
                  <label for="PopupNewsletterEmail-{{ section_id }}" class="visually-hidden">
                    {{ 'newsletter.email_placeholder' | t }}
                  </label>
                  <input
                    type="email"
                    id="PopupNewsletterEmail-{{ section_id }}"
                    name="contact[email]"
                    class="form-input popup-form__input"
                    placeholder="{{ 'newsletter.email_placeholder' | t }}"
                    required
                    autocomplete="email"
                    {% if form.errors %}
                      aria-invalid="true"
                      aria-describedby="Popup-error-{{ section_id }}"
                    {% endif %}
                  >
                  <button type="submit" class="btn btn--{{ section.settings.button_style }} popup-form__btn">
                    {%- if section.settings.button_label != blank -%}
                      {{ section.settings.button_label }}
                    {%- else -%}
                      {{ 'newsletter.subscribe' | t }}
                    {%- endif -%}
                  </button>
                </div>
              {%- endif -%}
            {%- endform -%}
          </div>
          {%- assign animation_index = animation_index | plus: 1 -%}

          {%- if section.settings.disclaimer != blank -%}
            {%- assign animation_delay = animation_index | times: 100 | plus: 200 -%}
            <div
              class="popup__disclaimer rte"
              data-animate="fade"
              data-popup-animate
              style="--delay: {{ animation_delay }}ms"
            >
              {{ section.settings.disclaimer }}
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const popup = document.querySelector('[data-popup]');
      const overlay = document.querySelector('[data-popup-overlay]');
      if (!popup || !overlay) return;

      const sectionId = popup.dataset.sectionId;
      const delaySeconds = parseInt(popup.dataset.delay) || 5;
      const cookieDays = parseInt(popup.dataset.cookieDays) || 30;
      const cookieName = `popup_newsletter_${sectionId}`;
      const closeBtn = popup.querySelector('[data-popup-close]');
      let triggerElement = null;

      // Close button - attach early so it works in design mode
      if (closeBtn) {
        closeBtn.addEventListener('click', closePopup);
      }

      // In theme editor, show popup immediately for preview
      if (Shopify.designMode) {
        showPopup();
        return;
      }

      // Check if already shown (cookie exists)
      if (getCookie(cookieName)) {
        return;
      }

      // Show after delay
      setTimeout(() => {
        showPopup();
        setCookie(cookieName, 'true', cookieDays);
      }, delaySeconds * 1000);

      function showPopup() {
        triggerElement = document.activeElement;
        popup.classList.add('is-visible');
        popup.setAttribute('aria-hidden', 'false');
        overlay.classList.add('is-active');
        document.body.style.overflow = 'hidden';

        // Trigger animations for elements inside popup
        setTimeout(() => {
          const animateElements = popup.querySelectorAll('[data-popup-animate]');
          animateElements.forEach(el => {
            el.classList.add('is-visible');
          });
        }, 100);

        // Focus first focusable element
        const firstFocusable = popup.querySelector('input, button:not([data-popup-close])');
        if (firstFocusable) {
          setTimeout(() => firstFocusable.focus(), 400);
        }

        // Add event listeners
        document.addEventListener('keydown', handleKeydown);
        overlay.addEventListener('click', closePopup);
      }

      function closePopup() {
        popup.classList.remove('is-visible');
        popup.setAttribute('aria-hidden', 'true');
        overlay.classList.remove('is-active');
        document.body.style.overflow = '';

        // Return focus
        if (triggerElement) {
          triggerElement.focus();
        }

        // Remove event listeners
        document.removeEventListener('keydown', handleKeydown);
        overlay.removeEventListener('click', closePopup);
      }

      function handleKeydown(e) {
        if (e.key === 'Escape') {
          closePopup();
          return;
        }

        // Focus trap
        if (e.key === 'Tab') {
          const focusables = popup.querySelectorAll('button, input, [tabindex]:not([tabindex="-1"])');
          const firstFocusable = focusables[0];
          const lastFocusable = focusables[focusables.length - 1];

          if (e.shiftKey && document.activeElement === firstFocusable) {
            e.preventDefault();
            lastFocusable.focus();
          } else if (!e.shiftKey && document.activeElement === lastFocusable) {
            e.preventDefault();
            firstFocusable.focus();
          }
        }
      }

      // Cookie helpers
      function setCookie(name, value, days) {
        const expires = new Date(Date.now() + days * 864e5).toUTCString();
        document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Lax`;
      }

      function getCookie(name) {
        return document.cookie.split('; ').find(row => row.startsWith(name + '='));
      }
    })();
  </script>
{%- endif -%}

{% stylesheet %}
  /* Overlay backdrop */
  .popup-overlay {
    position: fixed;
    inset: 0;
    background: rgb(0 0 0 / 0.6);
    backdrop-filter: blur(4px);
    z-index: var(--z-modal);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.4s var(--ease-out), visibility 0.4s var(--ease-out);
  }

  .popup-overlay.is-active {
    opacity: 1;
    visibility: visible;
  }

  /* Modal container */
  .popup-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    max-width: 900px;
    width: calc(100vw - var(--space-8));
    max-height: calc(100vh - var(--space-8));
    overflow: hidden;
    z-index: calc(var(--z-modal) + 1);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.4s var(--ease-out),
                transform 0.4s var(--ease-out),
                visibility 0.4s var(--ease-out);
  }

  .popup-modal.is-visible {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
  }

  /* Hide on mobile unless enabled */
  @media (max-width: 749px) {
    .popup-modal--hide-mobile,
    .popup-modal--hide-mobile + .popup-overlay {
      display: none;
    }
  }

  /* Close button */
  .popup__close {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    padding: 0;
    background: transparent;
    border: none;
    color: currentColor;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .popup__close:hover {
    opacity: 0.7;
  }

  .popup__close svg {
    width: 1.25rem;
    height: 1.25rem;
  }

  /* Split layout */
  .popup__inner {
    display: grid;
    grid-template-columns: 1fr;
    min-height: 400px;
  }

  @media (min-width: 750px) {
    .popup__inner {
      grid-template-columns: 1fr 1fr;
      min-height: 500px;
    }

    .popup__inner--reverse .popup__media {
      order: 2;
    }
  }

  /* Image side */
  .popup__media {
    position: relative;
    overflow: hidden;
    background-color: var(--color-muted);
  }

  @media (max-width: 749px) {
    .popup__media {
      display: none;
    }
  }

  .popup__image,
  .popup__placeholder {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Content side */
  .popup__content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: var(--space-8);
  }

  @media (min-width: 750px) {
    .popup__content {
      padding: var(--space-10) var(--space-8);
    }
  }

  .popup__content-inner {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .popup__subheading {
    margin-bottom: 0;
  }

  .popup__heading {
    margin: 0;
  }

  .popup__text {
    color: var(--color-muted);
  }

  /* Form */
  .popup-form__field {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  @media (min-width: 750px) {
    .popup-form__field {
      flex-direction: row;
    }

    .popup-form__input {
      flex: 1;
    }
  }

  .popup__disclaimer {
    font-size: var(--font-size-sm);
    color: var(--color-muted);
  }

  .popup__disclaimer a {
    color: currentColor;
    text-decoration: underline;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:sections.popup_newsletter.name",
  "tag": "aside",
  "class": "section-popup-newsletter",
  "limit": 1,
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_popup",
      "label": "t:sections.popup_newsletter.settings.enable.label",
      "default": false
    },
    {
      "type": "header",
      "content": "t:sections.popup_newsletter.settings.header_image.content"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "t:labels.image"
    },
    {
      "type": "select",
      "id": "image_position",
      "label": "t:sections.popup_newsletter.settings.image_position.label",
      "options": [
        { "value": "left", "label": "t:options.alignment.left" },
        { "value": "right", "label": "t:options.alignment.right" }
      ],
      "default": "left"
    },
    {
      "type": "header",
      "content": "t:sections.popup_newsletter.settings.header_content.content"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "t:labels.subheading",
      "default": "Newsletter"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "t:labels.heading",
      "default": "Get 10% off your first order"
    },
    {
      "type": "richtext",
      "id": "text",
      "label": "t:labels.text",
      "default": "<p>Sign up for exclusive access to new arrivals, sales, and members-only offers.</p>"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "t:labels.button_label",
      "default": "Subscribe"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "t:labels.button_style",
      "options": [
        { "value": "filled", "label": "t:options.button_style.filled" },
        { "value": "outline", "label": "t:options.button_style.outline" }
      ],
      "default": "filled"
    },
    {
      "type": "richtext",
      "id": "disclaimer",
      "label": "t:sections.popup_newsletter.settings.disclaimer.label",
      "default": "<p>By subscribing, you agree to our <a href=\"/policies/privacy-policy\">privacy policy</a>.</p>"
    },
    {
      "type": "header",
      "content": "t:sections.popup_newsletter.settings.header_behavior.content"
    },
    {
      "type": "range",
      "id": "delay_seconds",
      "min": 1,
      "max": 30,
      "step": 1,
      "unit": "s",
      "label": "t:sections.popup_newsletter.settings.delay.label",
      "default": 5
    },
    {
      "type": "range",
      "id": "cookie_days",
      "min": 1,
      "max": 90,
      "step": 1,
      "unit": "d",
      "label": "t:sections.popup_newsletter.settings.cookie_days.label",
      "info": "t:sections.popup_newsletter.settings.cookie_days.info",
      "default": 30
    },
    {
      "type": "checkbox",
      "id": "show_on_mobile",
      "label": "t:sections.popup_newsletter.settings.show_on_mobile.label",
      "default": false
    },
    {
      "type": "header",
      "content": "t:labels.section"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:labels.color_scheme",
      "default": "scheme_1"
    }
  ],
  "presets": [
    {
      "name": "t:sections.popup_newsletter.name"
    }
  ]
}
{% endschema %}
